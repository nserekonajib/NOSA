{% extends "adminbase.html" %}

{% block title %}Member Incomes - LUNSERK SACCO Admin{% endblock %}

{% block breadcrumb %}Expenses & Incomes / Member Incomes{% endblock %}

{% block page_title %}Member Incomes{% endblock %}

{% block page_subtitle %}Income generated from members (interest, fees, penalties){% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Filters -->
    <div class="card-glass rounded-2xl p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h2 class="text-lg font-bold text-gray-800">Member Income Records</h2>
                <p class="text-sm text-gray-600">Total: UGX {{ "{:,.0f}".format(total_amount) }}</p>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                <!-- Date Range -->
                <div class="flex items-center gap-2">
                    <input type="date" id="start_date" value="{{ start_date }}"
                           class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <span class="text-gray-500">to</span>
                    <input type="date" id="end_date" value="{{ end_date }}"
                           class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Income Type Filter -->
                <select id="income_type_filter"
                        class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Income Types</option>
                    <option value="loan_interest" {% if income_type == 'loan_interest' %}selected{% endif %}>Loan Interest</option>
                    <option value="membership_fee" {% if income_type == 'membership_fee' %}selected{% endif %}>Membership Fee</option>
                    <option value="penalty" {% if income_type == 'penalty' %}selected{% endif %}>Penalty</option>
                    <option value="other" {% if income_type == 'other' %}selected{% endif %}>Other</option>
                </select>
                
                <!-- Apply Filters Button -->
                <button onclick="applyFilters()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors">
                    <i class="fas fa-filter mr-2"></i> Filter
                </button>
            </div>
        </div>
        
        <!-- Income Type Summary -->
        {% if totals_by_type %}
        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            {% for type, amount in totals_by_type.items() %}
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-600 uppercase">{{ type|replace('_', ' ')|title }}</p>
                        <p class="text-xl font-bold text-gray-800">UGX {{ "{:,.0f}".format(amount) }}</p>
                    </div>
                    {% if type == 'loan_interest' %}
                    <i class="fas fa-percentage text-blue-500 text-xl"></i>
                    {% elif type == 'membership_fee' %}
                    <i class="fas fa-id-card text-green-500 text-xl"></i>
                    {% elif type == 'penalty' %}
                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                    {% else %}
                    <i class="fas fa-money-bill text-purple-500 text-xl"></i>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Member Incomes Table -->
    <div class="card-glass rounded-2xl overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Income Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for income in incomes %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-user text-blue-600 text-xs"></i>
                                    </div>
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ income.members.full_name }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ income.members.member_number }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                                {% if income.income_type == 'loan_interest' %}bg-blue-100 text-blue-800
                                {% elif income.income_type == 'membership_fee' %}bg-green-100 text-green-800
                                {% elif income.income_type == 'penalty' %}bg-red-100 text-red-800
                                {% else %}bg-purple-100 text-purple-800{% endif %}">
                                {% if income.income_type == 'loan_interest' %}
                                <i class="fas fa-percentage mr-1"></i>
                                {% elif income.income_type == 'membership_fee' %}
                                <i class="fas fa-id-card mr-1"></i>
                                {% elif income.income_type == 'penalty' %}
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                {% else %}
                                <i class="fas fa-money-bill mr-1"></i>
                                {% endif %}
                                {{ income.income_type|replace('_', ' ')|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-bold text-gray-900">
                            UGX {{ "{:,.0f}".format(income.amount|float) }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {{ income.payment_date }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            {{ income.description or 'N/A' }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {{ income.reference_id or 'N/A' }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-users text-gray-400 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-700 mb-2">No Member Incomes</h3>
                            <p class="text-gray-600">No income records found for the selected period</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Record Member Income Button -->
    <div class="fixed bottom-6 right-6 z-10">
        <button onclick="openRecordIncomeModal()"
                class="w-14 h-14 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-full shadow-lg hover:from-green-700 hover:to-green-800 transition-all hover-lift flex items-center justify-center">
            <i class="fas fa-plus text-xl"></i>
        </button>
    </div>
</div>

<!-- Record Member Income Modal -->
<div id="recordIncomeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Record Member Income</h3>
        <form id="recordIncomeForm" class="space-y-4">
            <div>
                <label for="member_select" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user text-blue-500 mr-1"></i> Select Member *
                </label>
                <select id="member_select" name="member_id" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Choose a member...</option>
                    <!-- Will be populated by JavaScript -->
                </select>
            </div>
            
            <div>
                <label for="income_type" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-tag text-blue-500 mr-1"></i> Income Type *
                </label>
                <select id="income_type" name="income_type" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select type...</option>
                    <option value="loan_interest">Loan Interest</option>
                    <option value="membership_fee">Membership Fee</option>
                    <option value="penalty">Penalty</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-money-bill-wave text-blue-500 mr-1"></i> Amount (UGX) *
                </label>
                <input type="number" id="amount" name="amount" required step="100"
                       class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="50000">
            </div>
            
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-align-left text-blue-500 mr-1"></i> Description
                </label>
                <textarea id="description" name="description" rows="2"
                          class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Brief description of this income..."></textarea>
            </div>
            
            <div>
                <label for="reference_id" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-hashtag text-blue-500 mr-1"></i> Reference ID
                </label>
                <input type="text" id="reference_id" name="reference_id"
                       class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="Loan ID or transaction reference">
            </div>
            
            <div>
                <label for="payment_date" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt text-blue-500 mr-1"></i> Payment Date *
                </label>
                <input type="date" id="payment_date" name="payment_date" required
                       value="{{ datetime.now().date().isoformat() }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeModal('recordIncomeModal')"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700">
                    Record Income
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Apply filters
    function applyFilters() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const incomeType = document.getElementById('income_type_filter').value;
        
        let url = '{{ url_for("expense_incomes.member_incomes_list") }}';
        const params = new URLSearchParams();
        
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (incomeType) params.append('income_type', incomeType);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        window.location.href = url;
    }
    
    // Modal functions
    function openRecordIncomeModal() {
        // Load members for dropdown
        fetch('/admin/members/api/list?limit=100')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('member_select');
                    select.innerHTML = '<option value="">Choose a member...</option>';
                    
                    data.members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.full_name} (${member.member_number})`;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('recordIncomeModal').classList.remove('hidden');
                } else {
                    alert('Error loading members');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading members');
            });
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }
    
    // Record income form submission
    document.getElementById('recordIncomeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const button = this.querySelector('button[type="submit"]');
        const originalText = button.innerHTML;
        
        // Show loading
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
        button.disabled = true;
        
        fetch('{{ url_for("expense_incomes.record_member_income") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal('recordIncomeModal');
                showSuccessMessage(data.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                button.innerHTML = originalText;
                button.disabled = false;
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            button.innerHTML = originalText;
            button.disabled = false;
            alert('Error recording income');
        });
    });
    
    // Success message
    function showSuccessMessage(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 z-50 px-6 py-3 bg-green-50 text-green-700 rounded-xl shadow-lg border-l-4 border-green-500';
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-3 text-lg"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // Set default dates if not set
    if (!document.getElementById('start_date').value) {
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
        document.getElementById('start_date').value = oneMonthAgo.toISOString().split('T')[0];
    }
    
    if (!document.getElementById('end_date').value) {
        document.getElementById('end_date').value = new Date().toISOString().split('T')[0];
    }
</script>

<style>
    .hover-lift {
        transition: transform 0.2s ease-in-out;
    }
    
    .hover-lift:hover {
        transform: translateY(-2px);
    }
    
    table {
        min-width: 800px;
    }
    
    @media (min-width: 768px) {
        table {
            min-width: 0;
        }
    }
</style>
{% endblock %}