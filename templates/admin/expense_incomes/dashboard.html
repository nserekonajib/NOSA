{% extends "adminbase.html" %}

{% block title %}Financial Dashboard - LUNSERK SACCO Admin{% endblock %}
{% block breadcrumb %}Finance / Dashboard{% endblock %}
{% block page_title %}Financial Dashboard{% endblock %}
{% block page_subtitle %}Comprehensive overview of income, expenses, and profitability metrics{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="card-glass rounded-xl p-6 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Filter by Date Range</h3>
        <form method="GET" action="{{ url_for('expense_incomes.dashboard') }}" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Start Date
                    </label>
                    <input type="date" 
                           name="start_date" 
                           value="{{ start_date }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        End Date
                    </label>
                    <input type="date" 
                           name="end_date" 
                           value="{{ end_date }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex items-end space-x-3">
                    <button type="submit" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Apply Filter
                    </button>
                    
                    <a href="{{ url_for('expense_incomes.dashboard') }}" 
                       class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Reset
                    </a>
                    
                    <!-- Quick Date Range Buttons -->
                    <div class="ml-auto flex space-x-2">
                        <button type="button"
                                onclick="setDateRange('today')"
                                class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                            Today
                        </button>
                        <button type="button"
                                onclick="setDateRange('week')"
                                class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                            This Week
                        </button>
                        <button type="button"
                                onclick="setDateRange('month')"
                                class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                            This Month
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Current Date Range Display -->
            {% if profit_data.start_date and profit_data.end_date %}
            <div class="pt-4 border-t border-gray-200">
                <p class="text-sm text-gray-600">
                    Showing data from <span class="font-semibold">{{ profit_data.start_date }}</span> 
                    to <span class="font-semibold">{{ profit_data.end_date }}</span>
                </p>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Key Financial Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Member Revenue Card -->
        <div class="card-glass rounded-xl p-6 border border-gray-100 hover:border-green-100 transition-colors">
            <div class="flex items-start justify-between mb-4">
                <div class="p-3 bg-green-50 rounded-lg shadow-sm">
                    <i class="fas fa-users text-green-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-500 bg-gray-50 px-2 py-1 rounded">
                    {{ profit_data.start_date }}
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1">
                UGX {{ "{:,.0f}".format(profit_data.total_member_income|float) }}
            </h3>
            <p class="text-sm text-gray-600 mb-3">Member Revenue</p>
        </div>

        <!-- Other Income Card -->
        <div class="card-glass rounded-xl p-6 border border-gray-100 hover:border-blue-100 transition-colors">
            <div class="flex items-start justify-between mb-4">
                <div class="p-3 bg-blue-50 rounded-lg shadow-sm">
                    <i class="fas fa-money-bill-wave text-blue-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-500 bg-gray-50 px-2 py-1 rounded">
                    {{ profit_data.start_date }}
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1">
                UGX {{ "{:,.0f}".format(profit_data.total_other_income|float) }}
            </h3>
            <p class="text-sm text-gray-600 mb-3">Other Income</p>
        </div>

        <!-- Loan Interest Income Card -->
        <div class="card-glass rounded-xl p-6 border border-gray-100 hover:border-purple-100 transition-colors">
            <div class="flex items-start justify-between mb-4">
                <div class="p-3 bg-purple-50 rounded-lg shadow-sm">
                    <i class="fas fa-percentage text-purple-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-500 bg-gray-50 px-2 py-1 rounded">
                    {{ profit_data.start_date }}
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1">
                UGX {{ "{:,.0f}".format(profit_data.total_loan_interest|float) }}
            </h3>
            <p class="text-sm text-gray-600 mb-3">Loan Interest</p>
        </div>

        <!-- Shares Income Card -->
        <div class="card-glass rounded-xl p-6 border border-gray-100 hover:border-orange-100 transition-colors">
            <div class="flex items-start justify-between mb-4">
                <div class="p-3 bg-orange-50 rounded-lg shadow-sm">
                    <i class="fas fa-chart-pie text-orange-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-500 bg-gray-50 px-2 py-1 rounded">
                    {{ profit_data.start_date }}
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1">
                UGX {{ "{:,.0f}".format(profit_data.total_shares_income|float) }}
            </h3>
            <p class="text-sm text-gray-600 mb-3">Shares Income</p>
        </div>
    </div>

    <!-- Operational Expenses and Net Profit -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div class="card-glass rounded-xl p-6 border border-gray-100 hover:border-red-100 transition-colors">
            <div class="flex items-start justify-between mb-4">
                <div class="p-3 bg-red-50 rounded-lg shadow-sm">
                    <i class="fas fa-file-invoice-dollar text-red-600 text-lg"></i>
                </div>
                <span class="text-xs font-medium text-gray-500 bg-gray-50 px-2 py-1 rounded">
                    {{ profit_data.start_date }}
                </span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1">
                UGX {{ "{:,.0f}".format(profit_data.total_expenses|float) }}
            </h3>
            <p class="text-sm text-gray-600 mb-3">Operational Expenses</p>
        </div>

        <!-- Net Profit Card -->
        <div class="card-glass rounded-xl p-6 bg-gradient-to-br from-purple-600 to-indigo-700 shadow-lg transform hover:-translate-y-1 transition-transform">
            <div class="flex items-start justify-between mb-4">
                <div class="p-3 bg-white/20 rounded-lg backdrop-blur-sm">
                    <i class="fas fa-chart-line text-white text-lg"></i>
                </div>
                <span class="text-xs font-medium text-white/90 bg-white/10 px-2 py-1 rounded">
                    {{ profit_data.start_date }}
                </span>
            </div>
            <h3 class="text-2xl font-bold text-white mb-1">
                UGX {{ "{:,.0f}".format(profit_data.net_profit|float) }}
            </h3>
            <p class="text-sm text-white/90 mb-3">Net Profit</p>
            <div class="text-xs text-white/80">
                <span class="font-medium">Period:</span> {{ profit_data.start_date }} to {{ profit_data.end_date }}
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card-glass rounded-xl p-6 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-900 mb-6">Quick Actions</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <a href="{{ url_for('expense_incomes.add_expense') }}" 
               class="group p-4 bg-white border border-gray-200 rounded-xl hover:border-red-200 hover:shadow-md transition-all">
                <div class="flex items-center">
                    <div class="p-2 bg-red-50 group-hover:bg-red-100 rounded-lg mr-3 transition-colors">
                        <i class="fas fa-plus text-red-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 text-sm">Add Expense</h4>
                        <p class="text-xs text-gray-500">Record new expenditure</p>
                    </div>
                </div>
            </a>

            <a href="{{ url_for('expense_incomes.expense_categories') }}" 
               class="group p-4 bg-white border border-gray-200 rounded-xl hover:border-red-200 hover:shadow-md transition-all">
                <div class="flex items-center">
                    <div class="p-2 bg-red-50 group-hover:bg-red-100 rounded-lg mr-3 transition-colors">
                        <i class="fas fa-tags text-red-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 text-sm">Expense Categories</h4>
                        <p class="text-xs text-gray-500">Manage categories</p>
                    </div>
                </div>
            </a>

            <a href="{{ url_for('expense_incomes.add_other_income') }}" 
               class="group p-4 bg-white border border-gray-200 rounded-xl hover:border-green-200 hover:shadow-md transition-all">
                <div class="flex items-center">
                    <div class="p-2 bg-green-50 group-hover:bg-green-100 rounded-lg mr-3 transition-colors">
                        <i class="fas fa-plus text-green-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 text-sm">Add Income</h4>
                        <p class="text-xs text-gray-500">Record other income</p>
                    </div>
                </div>
            </a>

            <a href="{{ url_for('expense_incomes.income_categories') }}" 
            class="group p-4 bg-white border border-gray-200 rounded-xl hover:border-red-200 hover:shadow-md transition-all">
             <div class="flex items-center">
                 <div class="p-2 bg-red-50 group-hover:bg-red-100 rounded-lg mr-3 transition-colors">
                     <i class="fas fa-tags text-red-600"></i>
                 </div>
                 <div>
                     <h4 class="font-semibold text-gray-900 text-sm">Income Categories</h4>
                     <p class="text-xs text-gray-500">Manage categories</p>
                 </div>
             </div>
         </a>

            <a href="{{ url_for('expense_incomes.financial_reports') }}" 
               class="group p-4 bg-white border border-gray-200 rounded-xl hover:border-purple-200 hover:shadow-md transition-all">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-50 group-hover:bg-purple-100 rounded-lg mr-3 transition-colors">
                        <i class="fas fa-chart-bar text-purple-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 text-sm">View Reports</h4>
                        <p class="text-xs text-gray-500">Financial analysis</p>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Expenses -->
        <div class="card-glass rounded-xl p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Recent Expenses</h3>
                    <p class="text-sm text-gray-600">Latest operational expenditures</p>
                </div>
                <a href="{{ url_for('expense_incomes.expenses_list') }}" 
                   class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center">
                    View All
                    <i class="fas fa-chevron-right ml-1 text-xs"></i>
                </a>
            </div>
            
            <div class="space-y-3">
                {% for expense in recent_expenses %}
                <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-red-50 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-invoice-dollar text-red-600"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold text-gray-900">{{ expense.expense_categories.name }}</h4>
                            <p class="text-xs text-gray-500">{{ expense.expense_number }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-gray-900">UGX {{ "{:,.0f}".format(expense.amount|float) }}</p>
                        <p class="text-xs text-gray-500">{{ expense.payment_date }}</p>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-receipt text-gray-400 text-xl"></i>
                    </div>
                    <p class="text-gray-600 font-medium">No recent expenses</p>
                    <p class="text-sm text-gray-500 mt-1">Expenses will appear here once recorded</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Incomes -->
        <div class="card-glass rounded-xl p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Recent Incomes</h3>
                    <p class="text-sm text-gray-600">Latest revenue streams</p>
                </div>
                <a href="{{ url_for('expense_incomes.other_incomes_list') }}" 
                   class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center">
                    View All
                    <i class="fas fa-chevron-right ml-1 text-xs"></i>
                </a>
            </div>
            
            <div class="space-y-3">
                {% for income in recent_incomes %}
                <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-green-600"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold text-gray-900">{{ income.income_categories.name }}</h4>
                            <p class="text-xs text-gray-500">{{ income.income_number }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-gray-900">UGX {{ "{:,.0f}".format(income.amount|float) }}</p>
                        <p class="text-xs text-gray-500">{{ income.payment_date }}</p>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-hand-holding-usd text-gray-400 text-xl"></i>
                    </div>
                    <p class="text-gray-600 font-medium">No recent incomes</p>
                    <p class="text-sm text-gray-500 mt-1">Incomes will appear here once recorded</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Auto-refresh dashboard stats
    let refreshInterval;
    
    function refreshDashboardStats() {
        fetch('/admin/expense_incomes/api/dashboard-stats')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update today's metrics
                    updateMetric('todayExpenses', data.today_expenses);
                    updateMetric('todayIncomes', data.today_incomes);
                    updateMetric('todayProfit', data.today_incomes - data.today_expenses);
                    
                    // Update monthly metrics
                    updateMetric('monthExpenses', data.month_expenses);
                    updateMetric('monthIncomes', data.month_incomes);
                    updateMetric('monthProfit', data.month_profit);
                }
            })
            .catch(error => {
                console.warn('Error refreshing dashboard stats:', error);
                // Optionally show a subtle notification
                showRefreshError();
            });
    }
    
    function updateMetric(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            const formattedValue = parseFloat(value).toLocaleString();
            element.textContent = `UGX ${formattedValue}`;
            
            // Add visual feedback
            element.classList.add('text-update');
            setTimeout(() => element.classList.remove('text-update'), 500);
        }
    }
    
    function showRefreshError() {
        // Create or update a subtle notification
        const notification = document.getElementById('refresh-notification') || 
                           createNotificationElement();
        notification.textContent = 'Unable to refresh data. Retrying...';
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.add('hidden'), 3000);
    }
    
    function createNotificationElement() {
        const div = document.createElement('div');
        div.id = 'refresh-notification';
        div.className = 'hidden fixed bottom-4 right-4 bg-yellow-50 text-yellow-800 px-4 py-2 rounded-lg text-sm border border-yellow-200';
        document.body.appendChild(div);
        return div;
    }
    
    // Initialize auto-refresh
    document.addEventListener('DOMContentLoaded', function() {
        // Refresh immediately on load
        refreshDashboardStats();
        
        // Set up interval
        refreshInterval = setInterval(refreshDashboardStats, 60000);
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
        });
    });

    // JavaScript for quick date range buttons
function setDateRange(rangeType) {
    const today = new Date();
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    
    switch(rangeType) {
        case 'today':
            const todayStr = today.toISOString().split('T')[0];
            startDateInput.value = todayStr;
            endDateInput.value = todayStr;
            break;
            
        case 'week':
            // Start of week (Monday)
            const startOfWeek = new Date(today);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            startOfWeek.setDate(diff);
            
            startDateInput.value = startOfWeek.toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];
            break;
            
        case 'month':
            // Start of month
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            startDateInput.value = startOfMonth.toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];
            break;
    }
    
    // Auto-submit the form
    document.querySelector('form').submit();
}

// Set default dates if not set
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    
    if (!startDateInput.value) {
        // Default to start of month
        const today = new Date();
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        startDateInput.value = startOfMonth.toISOString().split('T')[0];
    }
    
    if (!endDateInput.value) {
        // Default to today
        const today = new Date();
        endDateInput.value = today.toISOString().split('T')[0];
    }
});
</script>


</script>

<style>
    .card-glass {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }
    
    .hover-lift {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .text-update {
        animation: textPulse 0.5s ease-in-out;
    }
    
    @keyframes textPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .card-glass {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }
    
    .hover-lift {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
</style>
{% endblock %}