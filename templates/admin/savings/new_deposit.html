{% extends "adminbase.html" %}

{% block title %}New Deposit - LUNSERK SACCO Admin{% endblock %}

{% block breadcrumb %}Savings / Deposits / New{% endblock %}

{% block page_title %}Create New Deposit{% endblock %}

{% block page_subtitle %}Process a deposit for a savings account{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Deposit Form Card -->
    <div class="card-glass rounded-2xl p-6">
        <form method="POST" action="{{ url_for('savings.new_deposit') }}" class="space-y-6">
            <!-- Account Selection -->
            <div>
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Select Account</h3>
                
                <div class="mb-4">
                    <label for="savings_account_id" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-wallet text-blue-500 mr-1"></i> Select Savings Account *
                    </label>
                    <select id="savings_account_id" name="savings_account_id" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <option value="">Select a savings account...</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}" 
                                {% if request.args.get('account') == account.id|string %}selected{% endif %}>
                            {{ account.account_number }} - {{ account.members.full_name }} 
                            (Balance: UGX {{ "{:,.0f}".format(account.current_balance) }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Account Preview -->
                <div id="accountPreview" class="hidden p-4 bg-blue-50 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-bold text-gray-800" id="accountName">-</h4>
                            <p class="text-sm text-gray-600" id="accountNumber">-</p>
                            <p class="text-sm text-gray-600" id="memberInfo">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Current Balance</p>
                            <p class="text-lg font-bold text-gray-800" id="accountBalance">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deposit Details -->
            <div>
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Deposit Details</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Amount -->
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-money-bill-wave text-blue-500 mr-1"></i> Deposit Amount (UGX) *
                        </label>
                        <input type="number" id="amount" name="amount" required min="1000" step="100"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                               placeholder="Enter amount">
                        <p class="text-xs text-gray-500 mt-1">Minimum deposit: UGX 1,000</p>
                    </div>
                    
                    <!-- Payment Method -->
                    <div>
                        <label for="payment_method" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-credit-card text-blue-500 mr-1"></i> Payment Method *
                        </label>
                        <select id="payment_method" name="payment_method" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <option value="">Select payment method...</option>
                            <option value="cash">Cash Payment</option>
                            <option value="pesapal">PesaPal Online Payment</option>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="bank_transfer">Bank Transfer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Description -->
                <div class="mt-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-file-alt text-blue-500 mr-1"></i> Description (Optional)
                    </label>
                    <textarea id="description" name="description" rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                              placeholder="Enter deposit description or notes"></textarea>
                </div>
            </div>

            <!-- Payment Method Details -->
            <div id="cashDetails" class="hidden p-4 bg-green-50 rounded-xl">
                <div class="flex items-center">
                    <i class="fas fa-money-bill-wave text-green-600 text-xl mr-3"></i>
                    <div>
                        <h4 class="font-bold text-gray-800">Cash Payment Instructions</h4>
                        <p class="text-sm text-gray-600 mt-1">
                            You will need to confirm cash receipt after member pays. 
                            The deposit will be marked as pending until you confirm cash receipt.
                        </p>
                    </div>
                </div>
            </div>
            
            <div id="pesapalDetails" class="hidden p-4 bg-purple-50 rounded-xl">
                <div class="flex items-center">
                    <i class="fas fa-credit-card text-purple-600 text-xl mr-3"></i>
                    <div>
                        <h4 class="font-bold text-gray-800">PesaPal Payment</h4>
                        <p class="text-sm text-gray-600 mt-1">
                            Member will be redirected to PesaPal to complete payment. 
                            Account will be credited automatically upon successful payment.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="pt-6 border-t border-gray-200">
                <div class="flex justify-between">
                    <a href="{{ url_for('savings.deposits') }}" 
                       class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Deposits
                    </a>
                    
                    <button type="submit" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all hover-lift">
                        <i class="fas fa-check-circle mr-2"></i> Create Deposit Request
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Information Card -->
    <div class="card-glass rounded-2xl p-6 mt-6">
        <div class="flex items-start">
            <div class="p-3 bg-blue-100 rounded-lg mr-4">
                <i class="fas fa-info-circle text-blue-500 text-xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Deposit Process Information</h3>
                <ul class="space-y-2 text-gray-600">
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span>Cash deposits require admin confirmation after receiving cash</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span>PesaPal payments are processed automatically</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span>All deposits are logged in the transaction history</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span>Deposit reference numbers are generated automatically</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span>Member will receive SMS/Email notification for completed deposits</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Account data for preview
    const accountsData = {
        {% for account in accounts %}
        "{{ account.id }}": {
            name: "{{ account.account_name }}",
            number: "{{ account.account_number }}",
            memberName: "{{ account.members.full_name }}",
            memberNumber: "{{ account.members.member_number }}",
            balance: "UGX {{ "{:,.0f}".format(account.current_balance) }}",
            rawBalance: {{ account.current_balance }}
        },
        {% endfor %}
    };

    // Update account preview
    document.getElementById('savings_account_id').addEventListener('change', function() {
        const accountId = this.value;
        const preview = document.getElementById('accountPreview');
        
        if (accountId && accountsData[accountId]) {
            const account = accountsData[accountId];
            document.getElementById('accountName').textContent = account.name;
            document.getElementById('accountNumber').textContent = account.number;
            document.getElementById('memberInfo').textContent = `${account.memberName} (${account.memberNumber})`;
            document.getElementById('accountBalance').textContent = account.balance;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    });

    // Show/hide payment method details
    document.getElementById('payment_method').addEventListener('change', function() {
        const method = this.value;
        
        // Hide all details sections
        document.getElementById('cashDetails').classList.add('hidden');
        document.getElementById('pesapalDetails').classList.add('hidden');
        
        // Show selected method details
        if (method === 'cash') {
            document.getElementById('cashDetails').classList.remove('hidden');
        } else if (method === 'pesapal') {
            document.getElementById('pesapalDetails').classList.remove('hidden');
        }
    });

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const amount = parseFloat(document.getElementById('amount').value);
        const accountId = document.getElementById('savings_account_id').value;
        const paymentMethod = document.getElementById('payment_method').value;
        
        if (!accountId) {
            e.preventDefault();
            alert('Please select a savings account');
            return;
        }
        
        if (amount < 1000) {
            e.preventDefault();
            alert('Minimum deposit amount is UGX 1,000');
            return;
        }
        
        if (!paymentMethod) {
            e.preventDefault();
            alert('Please select a payment method');
            return;
        }
        
        // Show confirmation based on payment method
        if (paymentMethod === 'cash') {
            if (!confirm('You selected Cash Payment. Make sure you receive cash from the member before confirming. Continue?')) {
                e.preventDefault();
            }
        } else if (paymentMethod === 'pesapal') {
            if (!confirm('You selected PesaPal Payment. Member will be redirected to PesaPal to complete payment. Continue?')) {
                e.preventDefault();
            }
        }
    });

    // Initialize account preview if account is pre-selected
    document.addEventListener('DOMContentLoaded', function() {
        const initialAccount = document.getElementById('savings_account_id').value;
        if (initialAccount) {
            document.getElementById('savings_account_id').dispatchEvent(new Event('change'));
        }
        
        const initialMethod = document.getElementById('payment_method').value;
        if (initialMethod) {
            document.getElementById('payment_method').dispatchEvent(new Event('change'));
        }
    });
</script>

<style>
    .hover-lift {
        transition: transform 0.2s ease-in-out;
    }
    
    .hover-lift:hover {
        transform: translateY(-2px);
    }
    
    select option {
        padding: 10px;
    }
</style>
{% endblock %}